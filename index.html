<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JWT en Angular ‚Äî Gu√≠a Completa</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --surface2: #1a1a25;
      --border: #2a2a3a;
      --accent: #6ee7b7;
      --accent2: #818cf8;
      --accent3: #f472b6;
      --text: #e2e8f0;
      --muted: #64748b;
      --token-color: #fbbf24;
      --header-color: #6ee7b7;
      --payload-color: #818cf8;
      --sig-color: #f472b6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* HEADER */
    .hero {
      padding: 60px 40px 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -100px; left: 50%;
      transform: translateX(-50%);
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(110,231,183,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero-badge {
      display: inline-block;
      background: rgba(110,231,183,0.1);
      border: 1px solid rgba(110,231,183,0.3);
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 6px 14px;
      border-radius: 20px;
      letter-spacing: 2px;
      margin-bottom: 20px;
      text-transform: uppercase;
    }
    h1 {
      font-size: clamp(36px, 6vw, 72px);
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 16px;
    }
    h1 span { color: var(--accent); }
    .hero-sub {
      color: var(--muted);
      font-size: 18px;
      font-weight: 400;
      max-width: 600px;
      margin: 0 auto 40px;
    }

    /* TOKEN VISUALIZER */
    .token-viz {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      word-break: break-all;
      line-height: 1.8;
    }
    .token-part { cursor: pointer; transition: opacity 0.2s; }
    .token-part:hover { opacity: 0.8; }
    .t-header { color: var(--header-color); }
    .t-dot { color: var(--muted); }
    .t-payload { color: var(--payload-color); }
    .t-sig { color: var(--sig-color); }
    .token-legend {
      display: flex; gap: 20px; justify-content: center;
      margin-top: 12px; flex-wrap: wrap;
    }
    .legend-item {
      display: flex; align-items: center; gap: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* DECODED PANEL */
    .decoded-panel {
      display: none;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto 40px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.7;
      animation: fadeIn 0.3s ease;
    }
    .decoded-panel.visible { display: block; }
    .decoded-title {
      font-family: 'Syne', sans-serif;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .json-key { color: var(--accent2); }
    .json-val { color: var(--accent); }
    .json-str { color: var(--accent3); }
    .json-num { color: var(--token-color); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

    /* MAIN LAYOUT */
    .container { max-width: 1100px; margin: 0 auto; padding: 0 40px 80px; }

    /* FLOW DIAGRAM */
    .flow-section {
      margin-bottom: 60px;
    }
    .section-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .section-title span { color: var(--accent); }
    .section-sub {
      color: var(--muted);
      margin-bottom: 30px;
      font-size: 15px;
      font-weight: 400;
    }

    .flow-diagram {
      display: flex;
      align-items: center;
      gap: 0;
      overflow-x: auto;
      padding: 30px 0;
    }
    .flow-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 18px;
      min-width: 150px;
      text-align: center;
      position: relative;
      flex-shrink: 0;
    }
    .flow-step:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      transition: all 0.2s;
    }
    .flow-icon {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .flow-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .flow-desc {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
    }
    .flow-arrow {
      color: var(--accent);
      font-size: 20px;
      padding: 0 8px;
      flex-shrink: 0;
    }
    .flow-step.highlight {
      border-color: var(--accent);
      background: rgba(110,231,183,0.05);
    }

    /* STEPS GRID */
    .steps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
    }
    .step-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      transition: border-color 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .step-card:hover {
      border-color: var(--accent2);
      transform: translateY(-3px);
    }
    .step-num {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
      letter-spacing: 2px;
      margin-bottom: 10px;
    }
    .step-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .step-desc {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
      font-weight: 400;
      margin-bottom: 16px;
    }
    .step-file {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      color: var(--accent3);
      display: inline-block;
    }

    /* CODE BLOCKS */
    .code-section { margin-bottom: 60px; }
    .code-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 0;
      overflow-x: auto;
    }
    .code-tab {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-bottom: none;
      padding: 10px 18px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .code-tab.active {
      background: var(--surface);
      color: var(--accent);
      border-color: var(--border);
    }
    .code-tab:hover:not(.active) { color: var(--text); }

    .code-block {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 8px 8px 8px;
      padding: 28px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      line-height: 1.7;
      overflow-x: auto;
      position: relative;
      display: none;
    }
    .code-block.active { display: block; }
    .copy-btn {
      position: absolute;
      top: 14px; right: 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .copy-btn:hover { color: var(--accent); border-color: var(--accent); }

    /* Syntax highlighting */
    .kw { color: #c084fc; }
    .cls { color: #38bdf8; }
    .fn { color: #6ee7b7; }
    .str { color: #f472b6; }
    .cmt { color: #475569; font-style: italic; }
    .dec { color: #fbbf24; }
    .typ { color: #818cf8; }
    .var { color: #e2e8f0; }
    .num { color: #fb923c; }

    /* SECURITY SECTION */
    .security-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 60px;
    }
    .sec-card {
      border-radius: 14px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    .sec-card.good { background: rgba(110,231,183,0.05); border-color: rgba(110,231,183,0.2); }
    .sec-card.bad { background: rgba(244,114,182,0.05); border-color: rgba(244,114,182,0.2); }
    .sec-icon { font-size: 24px; margin-bottom: 12px; }
    .sec-title { font-size: 15px; font-weight: 700; margin-bottom: 8px; }
    .sec-card.good .sec-title { color: var(--accent); }
    .sec-card.bad .sec-title { color: var(--accent3); }
    .sec-text { font-size: 13px; color: var(--muted); line-height: 1.6; font-weight: 400; }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 40px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px;
      font-weight: 400;
    }
    .footer span { color: var(--accent); }

    pre { white-space: pre; }
  </style>
</head>
<body>

  <div class="hero">
    <div class="hero-badge">Charla t√©cnica ¬∑ JWT + Angular</div>
    <h1>Autenticaci√≥n con <span>JWT</span><br>en Angular</h1>
    <p class="hero-sub">Gu√≠a paso a paso: desde cero hasta una app con login, interceptor HTTP y rutas protegidas.</p>

    <!-- Token real decodificable -->
    <div class="token-viz">
      <span class="token-part t-header" onclick="showDecoded('header')" title="Click para ver decodificado">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class="t-dot">.</span><span class="token-part t-payload" onclick="showDecoded('payload')" title="Click para ver decodificado">eyJzdWIiOiJ1c2VyXzEyMyIsIm5hbWUiOiJNYXJpYSBHYXJjaWEiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MTcwMDAwMzYwMH0</span><span class="t-dot">.</span><span class="token-part t-sig" onclick="showDecoded('sig')" title="Click para ver decodificado">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span>
    </div>
    <div class="token-legend">
      <span class="legend-item"><span class="legend-dot" style="background:var(--header-color)"></span> Header (algoritmo)</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--payload-color)"></span> Payload (datos)</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--sig-color)"></span> Signature (verificaci√≥n)</span>
      <span style="color:var(--muted);font-size:12px;font-family:'JetBrains Mono',monospace">üëÜ click en cada parte</span>
    </div>

    <div class="decoded-panel" id="decoded-panel">
      <div class="decoded-title" id="decoded-title"></div>
      <pre id="decoded-content"></pre>
    </div>
  </div>

  <div class="container">

    <!-- FLUJO JWT -->
    <div class="flow-section">
      <div class="section-title">Flujo <span>completo</span></div>
      <div class="section-sub">C√≥mo funciona JWT de extremo a extremo en una app Angular</div>
      <div class="flow-diagram">
        <div class="flow-step">
          <div class="flow-icon">üë§</div>
          <div class="flow-label">Login Form</div>
          <div class="flow-desc">Usuario env√≠a<br>email + password</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="flow-icon">üîê</div>
          <div class="flow-label">AuthService</div>
          <div class="flow-desc">POST /auth/login<br>al servidor</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step highlight">
          <div class="flow-icon">üéüÔ∏è</div>
          <div class="flow-label">JWT Token</div>
          <div class="flow-desc">Servidor responde<br>con el token</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="flow-icon">üíæ</div>
          <div class="flow-label">localStorage</div>
          <div class="flow-desc">Angular guarda<br>el token</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="flow-icon">‚ö°</div>
          <div class="flow-label">Interceptor</div>
          <div class="flow-desc">A√±ade Bearer<br>a cada request</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="flow-icon">üõ°Ô∏è</div>
          <div class="flow-label">AuthGuard</div>
          <div class="flow-desc">Protege rutas<br>privadas</div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="flow-icon">üè†</div>
          <div class="flow-label">Dashboard</div>
          <div class="flow-desc">Usuario accede<br>a contenido</div>
        </div>
      </div>
    </div>

    <!-- PASOS -->
    <div class="section-title" style="margin-bottom:8px">Los <span>7 pasos</span> clave</div>
    <div class="section-sub" style="margin-bottom:30px">Cada paso construye sobre el anterior</div>
    <div class="steps-grid">
      <div class="step-card">
        <div class="step-num">PASO 01</div>
        <div class="step-title">Crear el proyecto</div>
        <div class="step-desc">Generar la estructura base con Angular CLI, activar routing y configurar el HttpClient.</div>
        <span class="step-file">ng new jwt-demo --routing</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 02</div>
        <div class="step-title">AuthService</div>
        <div class="step-desc">Servicio central que gestiona login, logout, guardado del token y utilidades para decodificarlo.</div>
        <span class="step-file">auth/auth.service.ts</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 03</div>
        <div class="step-title">HTTP Interceptor</div>
        <div class="step-desc">Intercepta autom√°ticamente todas las peticiones HTTP y a√±ade el header Authorization.</div>
        <span class="step-file">auth/auth.interceptor.ts</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 04</div>
        <div class="step-title">AuthGuard</div>
        <div class="step-desc">Protege rutas sensibles. Si el token no existe o est√° expirado, redirige al login.</div>
        <span class="step-file">auth/auth.guard.ts</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 05</div>
        <div class="step-title">Login Component</div>
        <div class="step-desc">Formulario reactivo que llama al AuthService. Si la respuesta trae token, lo guarda y navega.</div>
        <span class="step-file">pages/login/login.component.ts</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 06</div>
        <div class="step-title">Dashboard Component</div>
        <div class="step-desc">Ruta protegida. Decodifica y muestra los datos del token al usuario autenticado.</div>
        <span class="step-file">pages/dashboard/dashboard.component.ts</span>
      </div>
      <div class="step-card">
        <div class="step-num">PASO 07</div>
        <div class="step-title">Configurar Rutas</div>
        <div class="step-desc">Definir rutas p√∫blicas y protegidas (con canActivate), y registrar el interceptor en providers.</div>
        <span class="step-file">app.routes.ts / app.config.ts</span>
      </div>
    </div>

    <!-- C√ìDIGO -->
    <div class="code-section">
      <div class="section-title" style="margin-bottom:8px">El <span>c√≥digo</span></div>
      <div class="section-sub" style="margin-bottom:20px">Cada archivo listo para copiar y usar</div>

      <div class="code-tabs">
        <div class="code-tab active" onclick="showTab('service')">auth.service.ts</div>
        <div class="code-tab" onclick="showTab('interceptor')">auth.interceptor.ts</div>
        <div class="code-tab" onclick="showTab('guard')">auth.guard.ts</div>
        <div class="code-tab" onclick="showTab('login')">login.component.ts</div>
        <div class="code-tab" onclick="showTab('dashboard')">dashboard.component.ts</div>
        <div class="code-tab" onclick="showTab('routes')">app.routes.ts</div>
        <div class="code-tab" onclick="showTab('config')">app.config.ts</div>
      </div>

      <!-- AUTH SERVICE -->
      <div class="code-block active" id="tab-service">
        <button class="copy-btn" onclick="copyCode('tab-service')">copiar</button>
<pre><span class="cmt">// src/app/auth/auth.service.ts</span>
<span class="kw">import</span> { <span class="cls">Injectable</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="cls">HttpClient</span> } <span class="kw">from</span> <span class="str">'@angular/common/http'</span>;
<span class="kw">import</span> { <span class="cls">Router</span> } <span class="kw">from</span> <span class="str">'@angular/router'</span>;
<span class="kw">import</span> { <span class="typ">Observable</span>, <span class="fn">tap</span> } <span class="kw">from</span> <span class="str">'rxjs'</span>;

<span class="dec">@Injectable</span>({ providedIn: <span class="str">'root'</span> })
<span class="kw">export class</span> <span class="cls">AuthService</span> {

  <span class="kw">private readonly</span> <span class="var">TOKEN_KEY</span> = <span class="str">'jwt_token'</span>;
  <span class="kw">private readonly</span> <span class="var">API_URL</span> = <span class="str">'https://tu-api.com/api'</span>;

  <span class="fn">constructor</span>(<span class="kw">private</span> <span class="var">http</span>: <span class="cls">HttpClient</span>, <span class="kw">private</span> <span class="var">router</span>: <span class="cls">Router</span>) {}

  <span class="cmt">/** Llama al endpoint de login y guarda el token */</span>
  <span class="fn">login</span>(<span class="var">email</span>: <span class="typ">string</span>, <span class="var">password</span>: <span class="typ">string</span>): <span class="typ">Observable</span>&lt;any&gt; {
    <span class="kw">return this</span>.<span class="var">http</span>.<span class="fn">post</span>(`<span class="str">${this.API_URL}/auth/login</span>`, { email, password })
      .<span class="fn">pipe</span>(
        <span class="fn">tap</span>((<span class="var">res</span>: any) => {
          <span class="kw">if</span> (<span class="var">res</span>.token) {
            <span class="kw">this</span>.<span class="fn">saveToken</span>(<span class="var">res</span>.token);
          }
        })
      );
  }

  <span class="cmt">/** Elimina el token y redirige al login */</span>
  <span class="fn">logout</span>(): <span class="typ">void</span> {
    localStorage.<span class="fn">removeItem</span>(<span class="kw">this</span>.<span class="var">TOKEN_KEY</span>);
    <span class="kw">this</span>.<span class="var">router</span>.<span class="fn">navigate</span>([<span class="str">'/login'</span>]);
  }

  <span class="cmt">/** Guarda el token en localStorage */</span>
  <span class="fn">saveToken</span>(<span class="var">token</span>: <span class="typ">string</span>): <span class="typ">void</span> {
    localStorage.<span class="fn">setItem</span>(<span class="kw">this</span>.<span class="var">TOKEN_KEY</span>, token);
  }

  <span class="cmt">/** Recupera el token almacenado */</span>
  <span class="fn">getToken</span>(): <span class="typ">string</span> | <span class="typ">null</span> {
    <span class="kw">return</span> localStorage.<span class="fn">getItem</span>(<span class="kw">this</span>.<span class="var">TOKEN_KEY</span>);
  }

  <span class="cmt">/** ¬øEst√° el usuario logueado y el token es v√°lido? */</span>
  <span class="fn">isLoggedIn</span>(): <span class="typ">boolean</span> {
    <span class="kw">const</span> <span class="var">token</span> = <span class="kw">this</span>.<span class="fn">getToken</span>();
    <span class="kw">if</span> (!token) <span class="kw">return false</span>;
    <span class="kw">return</span> !<span class="kw">this</span>.<span class="fn">isTokenExpired</span>(token);
  }

  <span class="cmt">/** Decodifica el payload del JWT (base64) */</span>
  <span class="fn">decodeToken</span>(): any {
    <span class="kw">const</span> <span class="var">token</span> = <span class="kw">this</span>.<span class="fn">getToken</span>();
    <span class="kw">if</span> (!token) <span class="kw">return null</span>;
    <span class="kw">try</span> {
      <span class="kw">const</span> <span class="var">payload</span> = token.<span class="fn">split</span>(<span class="str">'.'</span>)[<span class="num">1</span>];
      <span class="kw">return</span> JSON.<span class="fn">parse</span>(atob(<span class="var">payload</span>));
    } <span class="kw">catch</span> {
      <span class="kw">return null</span>;
    }
  }

  <span class="cmt">/** Comprueba si el token ha expirado con la claim "exp" */</span>
  <span class="kw">private</span> <span class="fn">isTokenExpired</span>(<span class="var">token</span>: <span class="typ">string</span>): <span class="typ">boolean</span> {
    <span class="kw">try</span> {
      <span class="kw">const</span> <span class="var">payload</span> = JSON.<span class="fn">parse</span>(atob(token.<span class="fn">split</span>(<span class="str">'.'</span>)[<span class="num">1</span>]));
      <span class="kw">const</span> <span class="var">expiry</span> = <span class="var">payload</span>.exp * <span class="num">1000</span>; <span class="cmt">// exp est√° en segundos</span>
      <span class="kw">return</span> Date.<span class="fn">now</span>() > <span class="var">expiry</span>;
    } <span class="kw">catch</span> {
      <span class="kw">return true</span>; <span class="cmt">// Si no podemos decodificarlo, asumimos expirado</span>
    }
  }
}</pre>
      </div>

      <!-- INTERCEPTOR -->
      <div class="code-block" id="tab-interceptor">
        <button class="copy-btn" onclick="copyCode('tab-interceptor')">copiar</button>
<pre><span class="cmt">// src/app/auth/auth.interceptor.ts</span>
<span class="kw">import</span> { <span class="cls">HttpInterceptorFn</span>, <span class="cls">HttpRequest</span>, <span class="cls">HttpHandlerFn</span> } <span class="kw">from</span> <span class="str">'@angular/common/http'</span>;
<span class="kw">import</span> { <span class="fn">inject</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="cls">AuthService</span> } <span class="kw">from</span> <span class="str">'./auth.service'</span>;

<span class="cmt">/**
 * Interceptor funcional (Angular 17+)
 * Se ejecuta en CADA petici√≥n HTTP de la app.
 * Si hay token, lo a√±ade al header Authorization.
 */</span>
<span class="kw">export const</span> <span class="var">authInterceptor</span>: <span class="cls">HttpInterceptorFn</span> = (
  <span class="var">req</span>: <span class="cls">HttpRequest</span>&lt;unknown&gt;,
  <span class="var">next</span>: <span class="cls">HttpHandlerFn</span>
) => {
  <span class="kw">const</span> <span class="var">authService</span> = <span class="fn">inject</span>(<span class="cls">AuthService</span>);
  <span class="kw">const</span> <span class="var">token</span> = <span class="var">authService</span>.<span class="fn">getToken</span>();

  <span class="cmt">// Si no hay token, dejamos pasar la request sin modificar</span>
  <span class="kw">if</span> (!token) {
    <span class="kw">return</span> <span class="fn">next</span>(<span class="var">req</span>);
  }

  <span class="cmt">// Clonamos la request (son inmutables) y a√±adimos el header</span>
  <span class="kw">const</span> <span class="var">authReq</span> = <span class="var">req</span>.<span class="fn">clone</span>({
    headers: <span class="var">req</span>.headers.<span class="fn">set</span>(<span class="str">'Authorization'</span>, `Bearer <span class="str">${token}</span>`)
  });

  <span class="kw">return</span> <span class="fn">next</span>(<span class="var">authReq</span>);
};</pre>
      </div>

      <!-- GUARD -->
      <div class="code-block" id="tab-guard">
        <button class="copy-btn" onclick="copyCode('tab-guard')">copiar</button>
<pre><span class="cmt">// src/app/auth/auth.guard.ts</span>
<span class="kw">import</span> { <span class="fn">inject</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="fn">CanActivateFn</span>, <span class="cls">Router</span> } <span class="kw">from</span> <span class="str">'@angular/router'</span>;
<span class="kw">import</span> { <span class="cls">AuthService</span> } <span class="kw">from</span> <span class="str">'./auth.service'</span>;

<span class="cmt">/**
 * Guard funcional (Angular 17+)
 * Se ejecuta ANTES de activar una ruta.
 * Devuelve true si hay sesi√≥n v√°lida, o redirige al login.
 */</span>
<span class="kw">export const</span> <span class="var">authGuard</span>: <span class="fn">CanActivateFn</span> = () => {
  <span class="kw">const</span> <span class="var">authService</span> = <span class="fn">inject</span>(<span class="cls">AuthService</span>);
  <span class="kw">const</span> <span class="var">router</span> = <span class="fn">inject</span>(<span class="cls">Router</span>);

  <span class="kw">if</span> (<span class="var">authService</span>.<span class="fn">isLoggedIn</span>()) {
    <span class="kw">return true</span>; <span class="cmt">// ‚úÖ Token v√°lido ‚Üí acceso permitido</span>
  }

  <span class="cmt">// ‚ùå Sin token o expirado ‚Üí al login</span>
  <span class="kw">return</span> <span class="var">router</span>.<span class="fn">createUrlTree</span>([<span class="str">'/login'</span>]);
};</pre>
      </div>

      <!-- LOGIN -->
      <div class="code-block" id="tab-login">
        <button class="copy-btn" onclick="copyCode('tab-login')">copiar</button>
<pre><span class="cmt">// src/app/pages/login/login.component.ts</span>
<span class="kw">import</span> { <span class="cls">Component</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="cls">CommonModule</span> } <span class="kw">from</span> <span class="str">'@angular/common'</span>;
<span class="kw">import</span> { <span class="cls">ReactiveFormsModule</span>, <span class="cls">FormBuilder</span>, <span class="cls">Validators</span> } <span class="kw">from</span> <span class="str">'@angular/forms'</span>;
<span class="kw">import</span> { <span class="cls">Router</span> } <span class="kw">from</span> <span class="str">'@angular/router'</span>;
<span class="kw">import</span> { <span class="cls">AuthService</span> } <span class="kw">from</span> <span class="str">'../../auth/auth.service'</span>;

<span class="dec">@Component</span>({
  selector: <span class="str">'app-login'</span>,
  standalone: <span class="kw">true</span>,
  imports: [<span class="cls">CommonModule</span>, <span class="cls">ReactiveFormsModule</span>],
  template: <span class="str">`
    &lt;div class="login-container"&gt;
      &lt;h2&gt;Iniciar Sesi√≥n&lt;/h2&gt;
      &lt;form [formGroup]="loginForm" (ngSubmit)="onSubmit()"&gt;
        &lt;input formControlName="email" type="email" placeholder="Email" /&gt;
        &lt;input formControlName="password" type="password" placeholder="Contrase√±a" /&gt;
        &lt;button type="submit" [disabled]="loginForm.invalid || loading"&gt;
          {{ loading ? 'Entrando...' : 'Entrar' }}
        &lt;/button&gt;
      &lt;/form&gt;
      &lt;p class="error" *ngIf="error"&gt;{{ error }}&lt;/p&gt;
    &lt;/div&gt;
  `</span>
})
<span class="kw">export class</span> <span class="cls">LoginComponent</span> {

  <span class="var">loginForm</span> = <span class="kw">this</span>.<span class="var">fb</span>.<span class="fn">group</span>({
    email:    [<span class="str">''</span>, [<span class="cls">Validators</span>.required, <span class="cls">Validators</span>.email]],
    password: [<span class="str">''</span>, [<span class="cls">Validators</span>.required, <span class="cls">Validators</span>.minLength(<span class="num">6</span>)]]
  });

  <span class="var">loading</span> = <span class="kw">false</span>;
  <span class="var">error</span> = <span class="str">''</span>;

  <span class="fn">constructor</span>(
    <span class="kw">private</span> <span class="var">fb</span>: <span class="cls">FormBuilder</span>,
    <span class="kw">private</span> <span class="var">auth</span>: <span class="cls">AuthService</span>,
    <span class="kw">private</span> <span class="var">router</span>: <span class="cls">Router</span>
  ) {}

  <span class="fn">onSubmit</span>(): <span class="typ">void</span> {
    <span class="kw">if</span> (<span class="kw">this</span>.<span class="var">loginForm</span>.invalid) <span class="kw">return</span>;

    <span class="kw">this</span>.<span class="var">loading</span> = <span class="kw">true</span>;
    <span class="kw">this</span>.<span class="var">error</span> = <span class="str">''</span>;

    <span class="kw">const</span> { email, password } = <span class="kw">this</span>.<span class="var">loginForm</span>.value;

    <span class="kw">this</span>.<span class="var">auth</span>.<span class="fn">login</span>(email!, password!).<span class="fn">subscribe</span>({
      next: () => <span class="kw">this</span>.<span class="var">router</span>.<span class="fn">navigate</span>([<span class="str">'/dashboard'</span>]),
      error: (<span class="var">err</span>) => {
        <span class="kw">this</span>.<span class="var">error</span> = <span class="var">err</span>.error?.message || <span class="str">'Credenciales incorrectas'</span>;
        <span class="kw">this</span>.<span class="var">loading</span> = <span class="kw">false</span>;
      }
    });
  }
}</pre>
      </div>

      <!-- DASHBOARD -->
      <div class="code-block" id="tab-dashboard">
        <button class="copy-btn" onclick="copyCode('tab-dashboard')">copiar</button>
<pre><span class="cmt">// src/app/pages/dashboard/dashboard.component.ts</span>
<span class="kw">import</span> { <span class="cls">Component</span>, <span class="cls">OnInit</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="cls">CommonModule</span> } <span class="kw">from</span> <span class="str">'@angular/common'</span>;
<span class="kw">import</span> { <span class="cls">AuthService</span> } <span class="kw">from</span> <span class="str">'../../auth/auth.service'</span>;

<span class="dec">@Component</span>({
  selector: <span class="str">'app-dashboard'</span>,
  standalone: <span class="kw">true</span>,
  imports: [<span class="cls">CommonModule</span>],
  template: <span class="str">`
    &lt;div class="dashboard"&gt;
      &lt;h1&gt;Hola, {{ userData?.name }}! üëã&lt;/h1&gt;
      &lt;p&gt;Rol: &lt;strong&gt;{{ userData?.role }}&lt;/strong&gt;&lt;/p&gt;
      &lt;p&gt;Token expira: {{ expiryDate | date:'short' }}&lt;/p&gt;

      &lt;details&gt;
        &lt;summary&gt;Ver payload del JWT&lt;/summary&gt;
        &lt;pre&gt;{{ userData | json }}&lt;/pre&gt;
      &lt;/details&gt;

      &lt;button (click)="logout()"&gt;Cerrar sesi√≥n&lt;/button&gt;
    &lt;/div&gt;
  `</span>
})
<span class="kw">export class</span> <span class="cls">DashboardComponent</span> <span class="kw">implements</span> <span class="cls">OnInit</span> {

  <span class="var">userData</span>: any;
  <span class="var">expiryDate</span>: <span class="cls">Date</span> | <span class="kw">null</span> = <span class="kw">null</span>;

  <span class="fn">constructor</span>(<span class="kw">private</span> <span class="var">auth</span>: <span class="cls">AuthService</span>) {}

  <span class="fn">ngOnInit</span>(): <span class="typ">void</span> {
    <span class="cmt">// Decodificamos el token para mostrar los datos del usuario</span>
    <span class="kw">this</span>.<span class="var">userData</span> = <span class="kw">this</span>.<span class="var">auth</span>.<span class="fn">decodeToken</span>();

    <span class="kw">if</span> (<span class="kw">this</span>.<span class="var">userData</span>?.exp) {
      <span class="kw">this</span>.<span class="var">expiryDate</span> = <span class="kw">new</span> <span class="cls">Date</span>(<span class="kw">this</span>.<span class="var">userData</span>.exp * <span class="num">1000</span>);
    }
  }

  <span class="fn">logout</span>(): <span class="typ">void</span> {
    <span class="kw">this</span>.<span class="var">auth</span>.<span class="fn">logout</span>();
  }
}</pre>
      </div>

      <!-- ROUTES -->
      <div class="code-block" id="tab-routes">
        <button class="copy-btn" onclick="copyCode('tab-routes')">copiar</button>
<pre><span class="cmt">// src/app/app.routes.ts</span>
<span class="kw">import</span> { <span class="typ">Routes</span> } <span class="kw">from</span> <span class="str">'@angular/router'</span>;
<span class="kw">import</span> { <span class="var">authGuard</span> } <span class="kw">from</span> <span class="str">'./auth/auth.guard'</span>;

<span class="kw">export const</span> <span class="var">routes</span>: <span class="typ">Routes</span> = [
  <span class="cmt">// Ruta p√∫blica</span>
  {
    path: <span class="str">'login'</span>,
    loadComponent: () => <span class="kw">import</span>(<span class="str">'./pages/login/login.component'</span>)
      .<span class="fn">then</span>(<span class="var">m</span> => <span class="var">m</span>.<span class="cls">LoginComponent</span>)
  },
  <span class="cmt">// Ruta PROTEGIDA ‚Äî requiere token v√°lido</span>
  {
    path: <span class="str">'dashboard'</span>,
    loadComponent: () => <span class="kw">import</span>(<span class="str">'./pages/dashboard/dashboard.component'</span>)
      .<span class="fn">then</span>(<span class="var">m</span> => <span class="var">m</span>.<span class="cls">DashboardComponent</span>),
    canActivate: [<span class="var">authGuard</span>]  <span class="cmt">// üõ°Ô∏è Aqu√≠ aplicamos el guard</span>
  },
  <span class="cmt">// Redirect por defecto</span>
  { path: <span class="str">''</span>, redirectTo: <span class="str">'/dashboard'</span>, pathMatch: <span class="str">'full'</span> },
  { path: <span class="str">'**'</span>, redirectTo: <span class="str">'/login'</span> }
];</pre>
      </div>

      <!-- CONFIG -->
      <div class="code-block" id="tab-config">
        <button class="copy-btn" onclick="copyCode('tab-config')">copiar</button>
<pre><span class="cmt">// src/app/app.config.ts</span>
<span class="kw">import</span> { <span class="cls">ApplicationConfig</span> } <span class="kw">from</span> <span class="str">'@angular/core'</span>;
<span class="kw">import</span> { <span class="fn">provideRouter</span> } <span class="kw">from</span> <span class="str">'@angular/router'</span>;
<span class="kw">import</span> { <span class="fn">provideHttpClient</span>, <span class="fn">withInterceptors</span> } <span class="kw">from</span> <span class="str">'@angular/common/http'</span>;
<span class="kw">import</span> { <span class="var">routes</span> } <span class="kw">from</span> <span class="str">'./app.routes'</span>;
<span class="kw">import</span> { <span class="var">authInterceptor</span> } <span class="kw">from</span> <span class="str">'./auth/auth.interceptor'</span>;

<span class="kw">export const</span> <span class="var">appConfig</span>: <span class="cls">ApplicationConfig</span> = {
  providers: [
    <span class="fn">provideRouter</span>(<span class="var">routes</span>),
    <span class="cmt">// üëá Registramos el interceptor aqu√≠ (Angular 17+ standalone)</span>
    <span class="fn">provideHttpClient</span>(
      <span class="fn">withInterceptors</span>([<span class="var">authInterceptor</span>])
    )
  ]
};</pre>
      </div>
    </div>

    <!-- SEGURIDAD -->
    <div class="section-title" style="margin-bottom:8px">Buenas <span>pr√°cticas</span> de seguridad</div>
    <div class="section-sub" style="margin-bottom:30px">Lo que debes y no debes hacer</div>
    <div class="security-grid">
      <div class="sec-card good">
        <div class="sec-icon">‚úÖ</div>
        <div class="sec-title">Tokens con expiraci√≥n corta</div>
        <div class="sec-text">Configura <code>exp</code> a 1h o menos. Usa refresh tokens para renovar sin pedir password.</div>
      </div>
      <div class="sec-card good">
        <div class="sec-icon">‚úÖ</div>
        <div class="sec-title">HTTPS siempre</div>
        <div class="sec-text">El token viaja en cada request. Sin HTTPS puede ser interceptado en texto plano.</div>
      </div>
      <div class="sec-card good">
        <div class="sec-icon">‚úÖ</div>
        <div class="sec-title">Verificar en el servidor</div>
        <div class="sec-text">Nunca conf√≠es solo en el frontend. El servidor debe validar la firma en cada request.</div>
      </div>
      <div class="sec-card bad">
        <div class="sec-icon">‚ùå</div>
        <div class="sec-title">No guardar datos sensibles</div>
        <div class="sec-text">El payload es base64, NO est√° cifrado. Cualquiera puede leerlo. No guardes passwords ni datos privados.</div>
      </div>
      <div class="sec-card bad">
        <div class="sec-icon">‚ùå</div>
        <div class="sec-title">Cuidado con localStorage</div>
        <div class="sec-text">Vulnerable a XSS. Para apps cr√≠ticas considera httpOnly cookies o memory storage.</div>
      </div>
      <div class="sec-card bad">
        <div class="sec-icon">‚ùå</div>
        <div class="sec-title">No validar solo en el guard</div>
        <div class="sec-text">El guard protege la UI, pero la API debe tener su propia autorizaci√≥n. Doble protecci√≥n.</div>
      </div>
    </div>

  </div>

  <div class="footer">
    Hecho con ‚ù§Ô∏è para la charla ¬∑ <span>JWT + Angular</span> ¬∑ Todos los archivos listos para usar
  </div>

  <script>
    // DECODED TOKEN VIEWER
    const decoded = {
      header:  { alg: "HS256", typ: "JWT" },
      payload: { sub: "user_123", name: "Maria Garcia", role: "admin", iat: 1700000000, exp: 1700003600 },
      sig: "‚ö†Ô∏è  La firma NO se puede decodificar ‚Äî es un hash HMAC.\nSolo el servidor puede verificarla con la clave secreta."
    };
    const colors = { header: '#6ee7b7', payload: '#818cf8', sig: '#f472b6' };
    const labels = { header: 'üü¢ Header ‚Äî Algoritmo y tipo', payload: 'üîµ Payload ‚Äî Datos del usuario', sig: 'üî¥ Signature ‚Äî Verificaci√≥n (no decodificable)' };

    function showDecoded(part) {
      const panel = document.getElementById('decoded-panel');
      const title = document.getElementById('decoded-title');
      const content = document.getElementById('decoded-content');
      title.textContent = labels[part];
      title.style.color = colors[part];
      if (part === 'sig') {
        content.textContent = decoded.sig;
        content.style.color = '#f472b6';
      } else {
        content.innerHTML = syntaxHighlight(JSON.stringify(decoded[part], null, 2));
      }
      panel.classList.add('visible');
    }

    function syntaxHighlight(json) {
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
        let cls = 'json-num';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) cls = 'json-key';
          else cls = 'json-str';
        } else if (/true|false/.test(match)) cls = 'json-val';
        return `<span class="${cls}">${match}</span>`;
      });
    }

    // TABS
    function showTab(tab) {
      document.querySelectorAll('.code-tab').forEach((t, i) => {
        const tabs = ['service','interceptor','guard','login','dashboard','routes','config'];
        t.classList.toggle('active', tabs[i] === tab);
      });
      document.querySelectorAll('.code-block').forEach(b => {
        b.classList.toggle('active', b.id === `tab-${tab}`);
      });
    }

    // COPY
    function copyCode(blockId) {
      const block = document.getElementById(blockId);
      const text = block.innerText.replace(/copiar\n/, '');
      navigator.clipboard.writeText(text).then(() => {
        const btn = block.querySelector('.copy-btn');
        btn.textContent = '‚úì copiado';
        btn.style.color = 'var(--accent)';
        setTimeout(() => { btn.textContent = 'copiar'; btn.style.color = ''; }, 2000);
      });
    }
  </script>
</body>
</html>
